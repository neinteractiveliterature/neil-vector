api:
  enabled: false

sources:
  # stdin:
  #   type: stdin
  internal:
    type: internal_logs
  fly_nats:
    type: "nats"
    url: "nats://[${NETWORK-fdaa}::3]:4223"
    queue: "${QUEUE-}"
    subject: "${SUBJECT-logs.>}"
    auth:
      strategy: "user_password"
      user_password:
        user: "${ORG-personal}"
        password: "${ACCESS_TOKEN?}"
    connection_name: "Fly logs stream"

transforms:
  preparse_nats_payload:
    type: remap
    inputs:
      - fly_nats
    source: ". = parse_json!(.message)"
  map_fly_app_name_to_application:
    type: remap
    inputs:
      - preparse_nats_payload
    source: .application = downcase(.fly.app.name) ?? "unknown"
  drop_own_logs:
    type: filter
    inputs:
      - map_fly_app_name_to_application
    condition: '.application != "neil-vector"'
  parse_json_message:
    type: remap
    inputs:
      - drop_own_logs
    source: |
      structured = parse_json(.message) ?? null
      if is_object(structured) {
        application = .application
        ., err = merge(., structured)
        .application = application
        if err == null {
          del(.message)
        }
      }

sinks:
  console:
    type: console
    inputs:
      - internal
    encoding:
      codec: text
  # debug:
  #   type: console
  #   inputs:
  #     - parse_json_message
  #   encoding:
  #     codec: json
  cloudwatch:
    inputs:
      - parse_json_message
    group_name: fly_apps
    type: aws_cloudwatch_logs
    stream_name: "{{ .application }}"
    region: us-east-1
    encoding:
      codec: json
